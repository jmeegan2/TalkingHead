<!DOCTYPE html>
<html>
<head>
  <link rel="icon" href="data:,">

  <title>Talking Head - minimal example</title>

  <style>
    body, html { width:100%; height:100%; max-width: 800px; margin: auto; position: relative; background-color: dimgray; color: white; }
    #james { display: block; width:100%; height:10%; }
    #avatar { display: block; width:100%; height:100%; }
    #controls { display: block; position: absolute; top: 20px; left: 10px; right: 10px; height: 50px; }
    #text { position: absolute; width: Calc( 100% - 110px ); height: 100%; top: 0; left: 0; bottom: 0; right: 110px; font-family: Arial; font-size: 20px; }
    #speak { display:block; position: absolute; top: 0; bottom: 0; right: 0; height: 100%; width: 100px; font-family: Arial; font-size: 20px; }
    #loading { display: block; position: absolute; bottom: 10px; left: 10px; right: 10px; height: 50px; font-family: Arial; font-size: 20px; }
  </style>

  <script type="importmap">
  { "imports":
    {
      "three": "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js/+esm",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/",
      "talkinghead": "https://cdn.jsdelivr.net/gh/met4citizen/TalkingHead@1.2/modules/talkinghead.mjs",

    }
  }
  
  </script>


  <script type="module">

     import { TalkingHead } from "talkinghead";
let head;
let waitingForResponse = false;

document.addEventListener('DOMContentLoaded', async function(e) {

  // Instantiate the class
  const nodeAvatar = document.getElementById('avatar');
  head = new TalkingHead(nodeAvatar, {
    ttsEndpoint: "https://eu-texttospeech.googleapis.com/v1beta1/text:synthesize",
    ttsApikey: "put-your-own-Google-TTS-API-key-here", // <- Change this
    lipsyncModules: ["en", "fi"],
    cameraView: "upper"
  });

  // Load and show the avatar
  const nodeLoading = document.getElementById('loading');
  try {
    nodeLoading.textContent = "Loading...";
    await head.showAvatar({
      url: 'https://models.readyplayer.me/64bfa15f0e72c63d7c3934a6.glb?morphTargets=ARKit,Oculus+Visemes,mouthOpen,mouthSmile,eyesClosed,eyesLookUp,eyesLookDown&textureSizeLimit=1024&textureFormat=png',
      body: 'M',
      avatarMood: 'neutral',
      ttsLang: "en-GB",
      ttsVoice: "en-GB-Standard-A",
      lipsyncLang: 'en'
    }, (ev) => {
      if (ev.lengthComputable) {
        let val = Math.min(100, Math.round(ev.loaded / ev.total * 100));
        nodeLoading.textContent = "Loading " + val + "%";
      }
    });
    nodeLoading.style.display = 'none';
  } catch (error) {
    console.log(error);
    nodeLoading.textContent = error.toString();
  }
  // Add keydown event listener for space key
  document.addEventListener('keydown', (event) => {
    if (event.code === 'Space') {
      listen();
    }
  });
});

window.listen = function() {
  if (waitingForResponse) return;
  console.log('listen');

  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'en-US';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.start();

  recognition.onresult = (event) => {
    const speechResult = event.results[0][0].transcript;
    console.log('Result: ', speechResult);
    waitingForResponse = true;
    callServer(speechResult);
  };

  recognition.onspeechend = () => recognition.stop();
  recognition.onerror = (event) => console.error('Error occurred in recognition: ', event.error);
};

async function callServer(speechResult) {
  try {
    const response = await fetch('http://localhost:3000/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: speechResult }),
    });

    if (!response.ok) throw new Error('Network response was not ok');

    const data = await response.json();
    console.log('Bot response:', data.botResponse);

    if (data.botResponse) head.speakText(data.botResponse);

    waitingForResponse = false;
  } catch (error) {
    console.error('Fetch error for chatgpt', error);
    waitingForResponse = false;
  }
}
  </script>
</head>

<body>
  <div id="avatar"></div>
  </div>
  <div id="loading"></div>
</body>

</html>
